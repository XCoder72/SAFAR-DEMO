<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>User Dashboard</title>
  
  <link rel="stylesheet" href="assets/style.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* --- DASHBOARD SPECIFIC STYLES --- */
    
    /* Override the default narrow login container */
    .dashboard-container {
        max-width: 1000px !important; 
        text-align: left !important;
        align-items: flex-start !important;
        padding: 30px !important;
    }

    /* Grid Layout for the Dashboard */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1.5fr; /* Left Col (Search) vs Right Col (History) */
        gap: 20px;
        margin-top: 20px;
    }

    /* Mobile Responsive: Stack them on small screens */
    @media (max-width: 768px) {
        .dashboard-grid { grid-template-columns: 1fr; }
    }

    /* Inner Cards (The Glass Panels inside the main board) */
    .glass-card {
        background: rgba(255, 255, 255, 0);
        border: 1px solid rgb(255, 255, 255);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
    }

    h3 { margin-bottom: 15px; font-weight: 600; color: #fff; }

    /* Form Inputs in Dashboard */
    .dash-input {
        background: rgb(0, 0, 0);
        border: 1px solid rgb(255, 255, 255);
        color: rgb(255, 255, 255);
        padding: 10px;
        border-radius: 8px;
        width: 100%;
        margin-bottom: 10px;
    }

    /* Booking List Items */
    .booking-item {
        background: rgba(255, 255, 255, 0.03);
        border-left: 3px solid #3b82f6; /* Blue accent */
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform 0.2s;
    }
    .booking-item:hover { transform: translateX(5px); background: rgba(255, 255, 255, 0.08); }

    /* Buttons */
    .btn-sm { padding: 5px 12px; font-size: 0.8rem; margin-left: 5px; }
    .btn-danger { background: linear-gradient(135deg, #ff416c, #ff4b2b); border:none; color:white; border-radius:6px; cursor:pointer;}
    .btn-action { background: rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:6px; cursor:pointer;}

    /* Modal Styling */
    .modal-back {
        position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
        display: none; align-items: center; justify-content: center; z-index: 99;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background: #1e293b; /* Dark Slate */
        padding: 25px; border-radius: 16px; width: 90%; max-width: 400px;
        border: 1px solid rgba(255,255,255,0.1);
        color: white;
    }
  </style>
  <style>
    /* Force the widget to sit on top of everything */
    #google_translate_element {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 9999; /* Very high Z-index */
    }
    
    /* Make the text WHITE so it is visible on dark backgrounds */
    .goog-te-gadget-simple {
        background-color: rgba(0, 0, 0, 0.5) !important; /* Dark semi-transparent background */
        border: 1px solid rgba(255, 255, 255, 0.5) !important;
        padding: 5px 10px !important;
        border-radius: 4px !important;
        color: white !important;
    }
    
    .goog-te-gadget-simple span {
        color: white !important;
    }

    /* Hide the Google Icon to make it smaller */
    .goog-te-gadget-icon {
        display: none !important;
    }
  </style>
</head>

<body>
  
  <div id="google_translate_element"></div>

  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,hi,mr,gu,pa,bn,ta,te', 
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
        autoDisplay: false
      }, 'google_translate_element');
    }
  </script>
  
  <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <div class="glass-container dashboard-container">
    
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:15px;">
      
      <div style="display:flex; gap:15px; align-items:center;">
        
        <div>
          <h2 style="margin:0; font-size:1.5rem;">User Dashboard</h2>
          <div style="font-size:0.85rem; color:#fafbff;">Welcome back, Passenger</div>
        </div>
      </div>

      <div style="display:flex; gap:10px;">
        <button class="btn-sos" onclick="openSosPage('user')">ðŸš¨ SOS</button>
        <button class="btn-action" style="padding:10px 15px;" onclick="window.location='homepage.html'"><h4>Home</h4></button>
        <button class="btn-action" style="padding:10px 15px;" onclick="logout()"><h4>Logout</h4></button>
      </div>
    </div>

    <div class="dashboard-grid">
      
      <div class="col">
        
        <div class="glass-card">
          <h3><i class="fas fa-search"></i> Find Transport</h3>
          <label class="subtitle" style="font-size:0.8rem;">Pickup Location</label>
          <input id="from" class="dash-input" placeholder="e.g. Railway Station">
          
          <label class="subtitle" style="font-size:0.8rem;">Drop Location</label>
          <input id="to" class="dash-input" placeholder="e.g. City Center">
          
          <button class="btn btn-primary" onclick="searchRoutes()" style="margin-top:10px;">
            Search Vehicles
          </button>
        </div>

        <div class="glass-card">
          <h3><i class="fas fa-map-marker-alt"></i> Live Tracking</h3>
          <label class="subtitle" style="font-size:0.8rem;">Enter Vehicle Number</label>
          <input id="vnum" class="dash-input" placeholder="e.g. MP07-AB-1234">
          
          <button class="btn btn-secondary" onclick="openVehicleMap()" style="width:100%;">
            Track Now
          </button>
        </div>

      </div>

      <div class="col">
        <div class="glass-card" style="min-height: 400px;">
          <h3 style="border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
            <i class="fas fa-history"></i> My Bookings
          </h3>
          <div id="bookingList" style="margin-top:15px;">
            <p style="text-align:center; color:#000000;">Loading history...</p>
          </div>
        </div>
      </div>

    </div>

  </div>

  <div id="modalBack" class="modal-back">
    <div class="modal-content" id="detailModal">
      <h3 id="m_title" style="color:#3b82f6;">Booking Details</h3>
      <div id="m_body" style="margin-top:15px; line-height:1.6; font-size:0.9rem;"></div>
      <div style="display:flex; justify-content:flex-end; margin-top:20px;">
        <button class="btn-action" style="padding:8px 20px;" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // --- Helpers ---
    function getStore(k){ try{ return JSON.parse(localStorage.getItem(k)||'null') }catch(e){return null} }
    function setStore(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // --- Session Check ---
    const current = getStore('ss_current');
    if(!current){ window.location = 'passenger.html'; }

    function logout(){
      localStorage.removeItem('ss_current');
      window.location = 'passenger.html';
    }

    function searchRoutes(){
      const f = document.getElementById('from').value.trim();
      const t = document.getElementById('to').value.trim();
      if(!f || !t){ alert('Please enter both locations'); return; }
      window.location = 'search_result.html?from=' + encodeURIComponent(f) + '&to=' + encodeURIComponent(t);
    }

    function openVehicleMap(){
      const v = document.getElementById('vnum').value.trim();
      if(!v){ alert('Enter vehicle number'); return; }
      window.location = 'vehicle_maps.html?vnum=' + encodeURIComponent(v);
    }

    // --- Render History (Updated for Dark Theme) ---
    function renderHistory(){
      const all = getStore('ss_bookings') || [];
      const user = getStore('ss_current') || {};
      const mine = all.filter(b => b.uid === (user.uid || ''));
      const list = document.getElementById('bookingList');
      
      list.innerHTML = '';
      if(mine.length === 0){
        list.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">No active bookings found.</div>';
        return;
      }

      // Sort: Newest first
      mine.sort((a,b)=> new Date(b.ts) - new Date(a.ts));

      mine.forEach(b => {
        const item = document.createElement('div');
        item.className = 'booking-item';
        
        // Dynamic HTML for the item
        item.innerHTML = `
          <div style="flex-grow:1;">
            <div style="font-weight:bold; font-size:1rem;">${escapeHtml(b.routeName || 'Auto Rickshaw')}</div>
            <div style="font-size:0.85rem; color:#cbd5e1;">${escapeHtml(b.from)} <i class="fas fa-arrow-right" style="font-size:0.7rem;"></i> ${escapeHtml(b.to)}</div>
            <div style="font-size:0.75rem; color:#94a3b8; margin-top:4px;">
               ${new Date(b.ts).toLocaleDateString()} â€¢ â‚¹${b.price || '50'}
            </div>
          </div>
          
          <div style="text-align:right;">
             <button class="btn-action btn-sm" onclick='viewBooking("${b.id}")'>Details</button>
             <button class="btn-danger btn-sm" onclick='cancelBooking("${b.id}")'>X</button>
          </div>
        `;
        list.appendChild(item);
      });
    }

    // --- Modal Logic ---
    function viewBooking(bid){
      const all = getStore('ss_bookings') || [];
      const b = all.find(x => x.id === bid);
      if(!b) return;
      
      const body = document.getElementById('m_body');
      body.innerHTML = `
        <p><strong>Route:</strong> ${escapeHtml(b.routeName)}</p>
        <p><strong>From:</strong> ${escapeHtml(b.from)}</p>
        <p><strong>To:</strong> ${escapeHtml(b.to)}</p>
        <p><strong>Time:</strong> ${escapeHtml(b.dep_time || 'Now')} - ${escapeHtml(b.arr_time || 'Later')}</p>
        <p><strong>Fare:</strong> â‚¹${b.price || 'â€”'}</p>
        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:10px 0;">
        <p style="font-size:0.8rem; color:#94a3b8;">ID: ${b.id}</p>
      `;
      document.getElementById('modalBack').style.display = 'flex';
    }

    function closeModal(){ document.getElementById('modalBack').style.display = 'none'; }

    function cancelBooking(bid){
      if(!confirm('Cancel this booking?')) return;
      let all = getStore('ss_bookings') || [];
      all = all.filter(x => x.id !== bid);
      setStore('ss_bookings', all);
      renderHistory();
    }

    // --- SOS Logic ---
    function openSosPage(role){
       window.location.href = 'SOS.html?role=passenger';
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', renderHistory);
  </script>

</body>
</html>