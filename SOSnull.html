<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SOS - Emergency Alert</title>
  
  <link rel="stylesheet" href="assets/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* --- EMERGENCY SPECIFIC STYLES --- */
    
    body {
        /* Override default background with a Red/Dark Alert Theme */
        background: linear-gradient(rgba(40, 0, 0, 0.9), rgba(20, 0, 0, 0.95)), 
                    url('assets/bg-safar.jpg'); /* Reuse your background image */
        background-size: cover;
    }

    .sos-container {
        border: 2px solid rgba(239, 68, 68, 0.5); /* Red Border */
        box-shadow: 0 0 50px rgba(220, 38, 38, 0.3); /* Red Glow */
        text-align: center;
        max-width: 500px;
    }

    /* The Countdown Timer */
    .timer-circle {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid #ef4444;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 20px auto;
        font-size: 3rem;
        font-weight: 800;
        color: #ef4444;
        background: rgba(0, 0, 0, 0.3);
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
        animation: heartbeat 1s infinite;
    }

    @keyframes heartbeat {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    /* Telemetry Text */
    .tech-text {
        font-family: 'Courier New', monospace;
        background: rgba(0, 0, 0, 0.4);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        margin-top: 15px;
        font-size: 0.9rem;
        color: #cbd5e1;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 15px;
        border-radius: 20px;
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid #ef4444;
        font-size: 0.8rem;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 15px;
    }

    /* Buttons */
    .btn-sos-send {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
        color: white;
        border: none;
        padding: 15px;
        width: 100%;
        font-size: 1.1rem;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
        box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        transition: transform 0.2s;
    }
    .btn-sos-send:hover { transform: scale(1.02); }

    .btn-cancel {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: #94a3b8;
        padding: 12px;
        width: 100%;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
        font-weight: 600;
    }
    .btn-cancel:hover { background: rgba(255,255,255,0.1); color: white; }

    /* Manual Input Inputs */
    .manual-input {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        padding: 8px;
        border-radius: 6px;
        width: 48%;
        font-size: 0.8rem;
    }

  </style>
  <style>
    /* Force the widget to sit on top of everything */
    #google_translate_element {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 9999; /* Very high Z-index */
    }
    
    /* Make the text WHITE so it is visible on dark backgrounds */
    .goog-te-gadget-simple {
        background-color: rgba(0, 0, 0, 0.5) !important; /* Dark semi-transparent background */
        border: 1px solid rgba(255, 255, 255, 0.5) !important;
        padding: 5px 10px !important;
        border-radius: 4px !important;
        color: white !important;
    }
    
    .goog-te-gadget-simple span {
        color: white !important;
    }

    /* Hide the Google Icon to make it smaller */
    .goog-te-gadget-icon {
        display: none !important;
    }
  </style>
</head>

<body>
  
  <div id="google_translate_element"></div>

  <script type="text/javascript">
    function googleTranslateElementInit() {
      new google.translate.TranslateElement({
        pageLanguage: 'en',
        includedLanguages: 'en,hi,mr,gu,pa,bn,ta,te', 
        layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
        autoDisplay: false
      }, 'google_translate_element');
    }
  </script>
  
  <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

  <div class="glass-container sos-container">
    
    <div style="margin-bottom: 20px;">
        <i class="fas fa-exclamation-triangle" style="font-size: 2.5rem; color: #ef4444; margin-bottom: 10px;"></i>
        <h1 style="font-size: 2rem; margin: 0; color: white;">EMERGENCY SOS</h1>
        <p style="color: #cbd5e1; font-size: 0.9rem; margin-top: 5px;">Alerting Emergency Contacts & Authorities</p>
    </div>

    <div id="statusArea">
        
        <div class="status-badge" id="roleInfo">Detecting User...</div>

        <div class="timer-circle" id="counter">30</div>
        <p style="color: #ef4444; font-size: 0.9rem; font-weight: 600;">Sending automatically in seconds...</p>

        <div class="tech-text">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span><i class="fas fa-satellite-dish"></i> GPS SIGNAL</span>
                <span id="accuracy" style="color:#10b981">Acquiring...</span>
            </div>
            <div id="coords" style="font-size: 1.1rem; font-weight: bold; color: white;">
                --.------, --.------
            </div>
        </div>

        <div style="margin-top: 15px; display:flex; justify-content:space-between;">
            <input id="manualLat" class="manual-input" placeholder="Lat (Optional)">
            <input id="manualLon" class="manual-input" placeholder="Lon (Optional)">
        </div>

        <div style="margin-top: 25px;">
            <button class="btn-sos-send" id="sendNowBtn">
                <i class="fas fa-paper-plane"></i> SEND ALERT NOW
            </button>
            <button class="btn-cancel" id="stopBtn">
                I AM SAFE (CANCEL)
            </button>
        </div>

    </div>

    <div id="sentArea" style="display:none; padding: 20px 0;">
        <div style="font-size: 4rem; color: #10b981; margin-bottom: 20px;">
            <i class="fas fa-check-circle"></i>
        </div>
        <h2 style="color: white; margin: 0;">ALERT SENT</h2>
        <p style="color: #cbd5e1; margin-top: 10px;">Help is on the way. Keep your device on.</p>
        
        <div class="tech-text" id="sentDetails" style="text-align: left; font-size: 0.8rem; line-height: 1.5;">
            </div>

        <button class="btn-cancel" onclick="closeAndReturn()" style="margin-top: 20px;">
            Close Window
        </button>
    </div>

  </div>

  <script>
    /* --- STORAGE HELPERS --- */
    function read(k,fallback){ try{ const s = localStorage.getItem(k); return s?JSON.parse(s):fallback }catch(e){return fallback} }
    function write(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

    /* --- ROLE DETECTION --- */
    const params = new URLSearchParams(window.location.search);
    const role = params.get('role') || (read('ss_current_driver') ? 'driver' : (read('ss_current') ? 'passenger' : 'unknown'));
    
    const roleBadge = document.getElementById('roleInfo');
    if(role === 'driver') roleBadge.innerText = 'DRIVER DETECTED';
    else if(role === 'passenger') roleBadge.innerText = 'PASSENGER DETECTED';
    else roleBadge.innerText = 'UNKNOWN USER';

    /* --- COUNTDOWN LOGIC --- */
    let counterEl = document.getElementById('counter');
    let seconds = 30;
    let timer = null;
    let watchId = null;
    let lastPos = null;
    let canceled = false;

    /* --- GEOLOCATION --- */
    function onGeoSuccess(p){
        lastPos = { lat: p.coords.latitude, lon: p.coords.longitude, accuracy: p.coords.accuracy, ts: new Date().toISOString() };
        document.getElementById('coords').textContent = `${lastPos.lat.toFixed(6)}, ${lastPos.lon.toFixed(6)}`;
        document.getElementById('accuracy').textContent = `Â±${Math.round(lastPos.accuracy)}m`;
        write('ss_last_loc', lastPos);
    }
    function onGeoError(err){
        document.getElementById('coords').textContent = "Locating...";
        document.getElementById('accuracy').textContent = "Weak Signal";
        // fallback
        const stored = read('ss_last_loc', null);
        if(stored){
            document.getElementById('coords').textContent = `${stored.lat.toFixed(6)}, ${stored.lon.toFixed(6)}`;
            document.getElementById('accuracy').textContent = "Last Known";
        }
    }

    if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(onGeoSuccess, onGeoError, { enableHighAccuracy:true, timeout:5000 });
        watchId = navigator.geolocation.watchPosition(onGeoSuccess, onGeoError, { enableHighAccuracy:true, maximumAge:2000, timeout:8000 });
    }

    /* --- TIMER START --- */
    function startCountdown(){
        counterEl.textContent = seconds;
        timer = setInterval(()=>{
            if(canceled) { clearInterval(timer); return; }
            seconds--;
            counterEl.textContent = seconds;
            if(seconds <= 0){
                clearInterval(timer);
                sendSOS();
            }
        }, 1000);
    }
    startCountdown();

    /* --- BUTTONS --- */
    document.getElementById('stopBtn').addEventListener('click', ()=>{
        canceled = true;
        clearInterval(timer);
        alert('False Alarm Confirmed. No alert sent.');
        closeAndReturn();
    });

    document.getElementById('sendNowBtn').addEventListener('click', ()=>{
        canceled = true;
        clearInterval(timer);
        sendSOS();
    });

    /* --- DATA BUILDER --- */
    function makeRecord(isFalse = false){
        const passenger = read('ss_current', null);
        const driver = read('ss_current_driver', null);
        const user = role === 'driver' ? (driver || passenger) : (passenger || driver) || null;

        let lat = null, lon = null;
        // Manual override check
        const mlat = parseFloat(document.getElementById('manualLat').value);
        const mlon = parseFloat(document.getElementById('manualLon').value);
        
        if(!isNaN(mlat) && !isNaN(mlon)) { lat = mlat; lon = mlon; }
        else if(lastPos){ lat = lastPos.lat; lon = lastPos.lon; }
        else {
            const stored = read('ss_last_loc', null);
            if(stored){ lat = stored.lat; lon = stored.lon; }
        }

        return {
            id: 'SOS_' + Date.now(),
            ts: new Date().toISOString(),
            role: role,
            userSummary: user ? { name: user.name || 'Unknown', contact: user.contact || user.phone || '-' } : null,
            vehicle: user && user.vehicle ? user.vehicle : null,
            lat: lat,
            lon: lon,
            status: 'sent'
        };
    }

    /* --- SEND LOGIC --- */
    function sendSOS(){
        const record = makeRecord(false);
        
        // 1. Add to Admin Queue
        const q = read('ss_sos_queue', []);
        q.unshift(record);
        write('ss_sos_queue', q);

        // 2. Add to Dashboard Alerts
        const alerts = read('ss_alerts', []);
        const alertPayload = {
            id: 'A_' + Date.now(),
            ts: record.ts,
            type: 'sos',
            msg: `SOS ALERT: ${record.userSummary ? record.userSummary.name : 'Unknown User'}`,
            role: record.role,
            lat: record.lat, lon: record.lon,
            vehicle: record.vehicle
        };
        alerts.unshift(alertPayload);
        write('ss_alerts', alerts);

        // 3. UI Update
        if(watchId && navigator.geolocation) navigator.geolocation.clearWatch(watchId);
        
        document.getElementById('statusArea').style.display = 'none';
        document.getElementById('sentArea').style.display = 'block';
        
        document.getElementById('sentDetails').innerHTML = `
            <strong>ID:</strong> ${record.id}<br>
            <strong>Location:</strong> ${record.lat}, ${record.lon}<br>
            <strong>Notified:</strong> Police, Ambulance, Agency
        `;
    }

    function closeAndReturn(){
        if(window.opener) window.close();
        else location.href = 'index.html';
    }
  </script>
</body>
</html>